<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>パズドラ 簡易EHP/軽減 計算 v7a（Web）</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:16px; background:#fff}
    h1{font-size:20px;margin:0 0 12px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:0 0 16px;background:#fff}
    label{display:block;font-size:14px;margin:10px 0 6px}
    input[type="number"],input[type="text"],select{
      width:100%;height:40px;box-sizing:border-box;border:1px solid #ccc;border-radius:8px;padding:0 10px;font-size:16px
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    .btn{width:100%;height:44px;border:0;border-radius:10px;background:#007aff;color:#fff;font-size:16px}
    .muted{opacity:.6}
    pre{white-space:pre-wrap;word-break:break-all;border:1px solid #ddd;border-radius:10px;padding:10px;background:#fafafa}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .seg{display:flex;border:1px solid #ccc;border-radius:10px;overflow:hidden}
    .seg button{flex:1;padding:8px;border:0;background:#f5f5f5}
    .seg button.active{background:#007aff;color:#fff}
  </style>
</head>
<body>
  <h1>パズドラ 簡易EHP/軽減 計算 v7a（Web）</h1>

  <div class="card">
    <label>HP入力モード</label>
    <div class="seg" id="modeSeg">
      <button type="button" data-v="raw" class="active">素のHP</button>
      <button type="button" data-v="final">最終HP</button>
    </div>

    <label>チームHP（素のHP または 最終HP）</label>
    <input id="team_hp" type="number" placeholder="例: 123456" />

    <label>チームHP強化(覚醒) 個数</label>
    <input id="teamhp_awkn" type="number" value="0" />

    <div class="row">
      <div>
        <label>リーダーHP倍率（例: 1.5）</label>
        <input id="ldr_hp" type="number" step="0.01" value="1" />
      </div>
      <div>
        <label>サブHP倍率</label>
        <input id="sub_hp" type="number" step="0.01" value="1" />
      </div>
    </div>

    <label>その他HP倍率（任意）</label>
    <input id="etc_hp" type="number" step="0.01" value="1" />

    <div class="row">
      <div>
        <label>リーダー軽減率（例: 35 または 35%）</label>
        <input id="ldr_red" type="text" placeholder="35 or 35%" />
      </div>
      <div>
        <label>サブ軽減率</label>
        <input id="sub_red" type="text" placeholder="25 or 25%" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>追加軽減1</label>
        <input id="add1" type="text" placeholder="5 or 5%（覚醒/バッジ等）" />
      </div>
      <div>
        <label>追加軽減2</label>
        <input id="add2" type="text" />
      </div>
    </div>
  </div>

  <div class="card">
    <label>敵の属性（属性軽減の適用先）</label>
    <select id="enemy_attr">
      <option value="none">なし</option>
      <option value="F">火</option>
      <option value="W">水</option>
      <option value="G">木</option>
      <option value="L">光</option>
      <option value="D">闇</option>
    </select>

    <label class="muted">属性軽減（覚醒 7%）：各属性の個数 [火/水/木/光/闇]</label>
    <div class="grid-5">
      <input id="aw7_F" type="number" min="0" value="0">
      <input id="aw7_W" type="number" min="0" value="0">
      <input id="aw7_G" type="number" min="0" value="0">
      <input id="aw7_L" type="number" min="0" value="0">
      <input id="aw7_D" type="number" min="0" value="0">
    </div>

    <label class="muted">属性軽減（潜在 1%/1枠）：各属性の個数</label>
    <div class="grid-5">
      <input id="lat1_F" type="number" min="0" value="0">
      <input id="lat1_W" type="number" min="0" value="0">
      <input id="lat1_G" type="number" min="0" value="0">
      <input id="lat1_L" type="number" min="0" value="0">
      <input id="lat1_D" type="number" min="0" value="0">
    </div>

    <label class="muted">属性軽減＋（潜在 2.5%/2枠）：各属性の個数</label>
    <div class="grid-5">
      <input id="lat25_F" type="number" min="0" value="0">
      <input id="lat25_W" type="number" min="0" value="0">
      <input id="lat25_G" type="number" min="0" value="0">
      <input id="lat25_L" type="number" min="0" value="0">
      <input id="lat25_D" type="number" min="0" value="0">
    </div>

    <label>敵のダメージ（任意）</label>
    <input id="enemy" type="number" placeholder="例: 999999" />
  </div>

  <button class="btn" id="calcBtn">計算</button>

  <div class="card">
    <label>結果</label>
    <pre id="result" style="min-height:160px"></pre>
  </div>

<script>
  // ---- ユーティリティ ----
  const $ = id => document.getElementById(id);
  const pct = s => {
    if(!s) return 0;
    s = String(s).trim().replace('%','');
    const v = parseFloat(s);
    return isNaN(v) ? 0 : v/100.0;
  };
  const mul = s => {
    if(!s) return 1;
    const v = parseFloat(s);
    return isNaN(v) ? 1 : v;
  };
  const toInt = s => {
    if(!s) return 0;
    const v = parseInt(String(s).replace(/,/g,''),10);
    return isNaN(v) ? 0 : v;
  };
  const nonneg = s => Math.max(0, toInt(s));

  // モード切替UI
  const modeSeg = $('modeSeg');
  modeSeg.querySelectorAll('button').forEach(btn=>{
    btn.onclick = () => {
      modeSeg.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      applyMode();
    };
  });
  function currentMode(){ // 'raw' or 'final'
    return modeSeg.querySelector('.active').dataset.v;
  }
  function applyMode(){
    const finalMode = currentMode()==='final';
    const hpFields = ['ldr_hp','sub_hp','etc_hp','teamhp_awkn'];
    hpFields.forEach(id=>{
      const el = $(id);
      if(finalMode && (id==='ldr_hp' || id==='sub_hp' || id==='etc_hp')){
        el.value = '1'; el.disabled = true; el.classList.add('muted');
      }else if(finalMode && id==='teamhp_awkn'){
        el.value = '0'; el.disabled = true; el.classList.add('muted');
      }else{
        el.disabled = false; el.classList.remove('muted');
        if(!el.value) el.value = (id==='teamhp_awkn')?'0':'1';
      }
    });
  }
  applyMode();

  // 属性係数（加算→上限100%）
  function attrCoeff(){
    const m = $('enemy_attr').value; // F/W/G/L/D or none
    if(m==='none') return {coeff:1, jp:'—', n7:0, n1:0, n25:0, pct:0};
    const n7  = nonneg($(`aw7_${m}`).value);
    const n1  = nonneg($(`lat1_${m}`).value);
    const n25 = nonneg($(`lat25_${m}`).value);
    let total = 0.07*n7 + 0.01*n1 + 0.025*n25;
    total = Math.max(0, Math.min(1, total));
    return {coeff: 1 - total, jp: {F:'火',W:'水',G:'木',L:'光',D:'闇'}[m], n7, n1, n25, pct: total*100};
  }

  // 計算
  $('calcBtn').onclick = ()=>{
    const input_hp = toInt($('team_hp').value);
    const finalMode = (currentMode()==='final');

    let hp_mul = mul($('ldr_hp').value) * mul($('sub_hp').value) * mul($('etc_hp').value);

    const hpAw = nonneg($('teamhp_awkn').value);
    if(!finalMode){
      hp_mul *= (1 + 0.05 * hpAw);
    }
    const final_hp = finalMode ? input_hp : Math.round(input_hp * hp_mul);

    // 一般軽減(乗算)
    let base_coeff = 1.0;
    ['ldr_red','sub_red','add1','add2'].forEach(id=>{
      base_coeff *= (1 - pct($(id).value));
    });

    // 属性軽減
    const ac = attrCoeff();
    const dmg_coeff = base_coeff * ac.coeff;
    const total_red = 1 - dmg_coeff;
    const ehp = Math.round(final_hp / Math.max(dmg_coeff, 1e-9));

    const enemy = toInt($('enemy').value);
    const lines = [];
    const b = '・ ';

    lines.push(b + 'HP入力モード: ' + (finalMode?'最終HP':'素のHP'));
    if(!finalMode){
      lines.push(b + `HP倍率の積(チームHP強化含む): ×${hp_mul.toFixed(4)}  ※チームHP強化=${hpAw}個 → ×(1+0.05×${hpAw})`);
    }
    lines.push(b + `最終HP: ${final_hp.toLocaleString()}`);
    lines.push(b + `総軽減(実質軽減率): ${(total_red*100).toFixed(2)}%`);
    lines.push(b + `被ダメ係数: ${dmg_coeff.toFixed(6)}`);
    lines.push(b + `実効HP(EHP): ${ehp.toLocaleString()}`);

    if($('enemy_attr').value!=='none'){
      lines.push(b + `属性軽減(敵属性: ${ac.jp}) [加算] 覚醒7%×${ac.n7}, 潜在1%×${ac.n1}, 潜在2.5%×${ac.n25} 合計: ${ac.pct.toFixed(2)}%`);
    }
    if(enemy>0){
      const taken = Math.round(enemy * dmg_coeff);
      const remain = final_hp - taken;
      const remainPct = final_hp>0 ? (remain/final_hp*100) : 0;
      const need_hp = Math.floor(enemy * dmg_coeff) + 1;
      const lives = remain >= 1;
      lines.push(b + `敵ダメージ: ${enemy.toLocaleString()}`);
      lines.push(b + `実際に受けるダメージ: ${taken.toLocaleString()}`);
      lines.push(b + `残りHP: ${Math.max(remain,0).toLocaleString()} (${Math.max(remainPct,0).toFixed(2)}%)`);
      lines.push(b + `生存可否: ${lives ? '◯ 生存' : '× 撃沈'}`);
      lines.push(b + `このダメージを1残しで耐える最終HP: ${need_hp.toLocaleString()}`);
    }

    $('result').textContent = lines.join('\n');
  };
</script>
</body>
</html>
