<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>パズドラ 簡易EHP/軽減 計算 (Web) - パッチ版</title>
<style>
  :root{--bg:#f6f7fb;--card:#ffffff;--accent:#1273eb;--text:#1d2330;--muted:#697386;--border:#e5e7f0;--radius:14px;}
  *{box-sizing:border-box}
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",Helvetica,Arial;background:var(--bg);color:var(--text);line-height:1.6}
  header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--border)}
  .wrap{max-width:760px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:0;padding:8px 0 12px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 1px 1px rgba(0,0,0,.02)}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media (min-width:720px){.grid{grid-template-columns:1fr 1fr}}
  label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
  input[type="number"],input[type="text"],select{width:100%;font-size:16px;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff;outline:none}
  input:focus,select:focus{border-color:#c9d7ff;box-shadow:0 0 0 3px rgba(18,115,235,.12)}
  .btn{display:block;width:100%;padding:14px 16px;border:0;border-radius:10px;background:var(--accent);color:#fff;font-size:16px;font-weight:600}
  .bullets{margin:0;padding-left:1.1em}
  .bullets li{margin:8px 0}
  footer{color:var(--muted);font-size:12px;text-align:center;padding:24px 0}
  .disabled{opacity:.5;pointer-events:none}
</style>
</head>
<body>
<header><div class="wrap"><h1>パズドラ 簡易EHP/軽減 計算 (Web)</h1></div></header>
<main class="wrap">
  <div class="card">
    <div class="grid">
      <div>
        <label for="mode">HP入力モード</label>
        <select id="mode">
          <option value="base" selected>素のHP（倍率を掛ける）</option>
          <option value="final">最終HP（倍率は1固定）</option>
        </select>
      </div>
      <div>
        <label for="team_hp">チームHP（素のHP または 最終HP）</label>
        <input id="team_hp" type="number" inputmode="numeric" placeholder="例: 123456">
      </div>
      <div>
        <label for="enemy">敵のダメージ（任意）</label>
        <input id="enemy" type="number" inputmode="numeric" placeholder="例: 999999">
      </div>
      <div>
        <label for="ldr_hp">リーダーHP倍率</label>
        <input id="ldr_hp" type="number" inputmode="decimal" value="1">
      </div>
      <div>
        <label for="sub_hp">サブHP倍率</label>
        <input id="sub_hp" type="number" inputmode="decimal" value="1">
      </div>
      <div>
        <label for="etc_hp">その他HP倍率(任意)</label>
        <input id="etc_hp" type="number" inputmode="decimal" value="1">
      </div>
      <div>
        <label for="ldr_red">リーダー軽減率</label>
        <input id="ldr_red" type="text" placeholder="例: 35 or 35%">
      </div>
      <div>
        <label for="sub_red">サブ軽減率</label>
        <input id="sub_red" type="text" placeholder="例: 25 or 25%">
      </div>
      <div>
        <label for="add1">追加軽減①</label>
        <input id="add1" type="text" placeholder="例: 5 or 5% (覚醒/バッジ等)">
      </div>
      <div>
        <label for="add2">追加軽減②</label>
        <input id="add2" type="text" placeholder="">
      </div>
    </div>
    <div style="margin-top:14px"><button class="btn" id="calcBtn">計算</button></div>
    <div class="card" style="margin-top:14px;border:1px dashed #e5e7f0">
      <ul class="bullets" id="out"></ul>
    </div>
  </div>
</main>
<footer class="wrap"><p>ブラウザだけで動作します。ホーム画面に追加もOK。</p></footer>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const num=v=>{if(v==null)return 0;const n=Number(String(v).replace(/,/g,''));return isFinite(n)?n:0};
  const pct=s=>{if(!s)return 0;const n=Number(String(s).trim().replace('%',''));return isFinite(n)?n/100:0};
  const mul=s=>{if(!s)return 1;const n=Number(String(s));return isFinite(n)?n:1};
  const fmt=n=>n.toLocaleString('ja-JP');

  function applyMode(){
    const finalMode = $('#mode').value==='final';
    for(const id of ['ldr_hp','sub_hp','etc_hp']){
      const el = $('#'+id);
      el.disabled = finalMode;
      el.classList.toggle('disabled', finalMode);
      if(finalMode) el.value = '1';
      else if(!el.value) el.value = '1';
    }
  }
  $('#mode').addEventListener('change', applyMode);
  applyMode();

  $('#calcBtn').addEventListener('click', ()=>{
    const mode = $('#mode').value; // base or final
    const inputHP = num($('#team_hp').value);
    const hpMul = mul($('#ldr_hp').value) * mul($('#sub_hp').value) * mul($('#etc_hp').value);
    const finalHP = (mode==='final') ? inputHP : Math.round(inputHP * hpMul);
    const reds = [pct($('#ldr_red').value), pct($('#sub_red').value), pct($('#add1').value), pct($('#add2').value)];
    let dmgCoeff = 1.0; reds.forEach(r=>dmgCoeff*=(1-r));
    const totalRed = 1 - dmgCoeff;
    const ehp = Math.round(finalHP / Math.max(dmgCoeff,1e-9));
    const enemy = num($('#enemy').value);

    const out = $('#out'); out.innerHTML='';
    const add=txt=>{const li=document.createElement('li');li.textContent=txt;out.appendChild(li);};

    add(`HP入力モード: ${mode==='final'?'最終HP':'素のHP'}`);
    if(mode!=='final') add(`HP倍率の積: ×${hpMul.toFixed(2)}`);
    add(`最終HP: ${fmt(finalHP)}`);
    add(`総軽減(実質軽減率): ${(totalRed*100).toFixed(2)}%`);
    add(`被ダメ係数: ${dmgCoeff.toFixed(4)}`);
    add(`実効HP(EHP): ${fmt(ehp)}`);

    if(enemy>0){
      const taken = Math.round(enemy*dmgCoeff);
      const remain = finalHP - taken;
      const remainPct = finalHP>0 ? Math.max(0,remain)/finalHP*100 : 0;
      const needHP = taken + 1;
      const survives = remain >= 1;
      add(`敵ダメージ: ${fmt(enemy)}`);
      add(`実際に受けるダメージ: ${fmt(taken)}`);
      add(`残りHP: ${fmt(Math.max(0,remain))}（${remainPct.toFixed(2)}%）`);
      add(`生存可否: ${survives?'◯ 生存':'× 撃沈'}`);
      add(`このダメージを1残しで耐えるのに必要な最終HP: ${fmt(needHP)}`);
    }
  });
})();
</script>
</body>
</html>
